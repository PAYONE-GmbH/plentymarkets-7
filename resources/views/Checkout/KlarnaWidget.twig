{% block body %}

    <script type="text/javascript">

        var payment = '{{payment_method}}'
        var containerPaymentMethod = payment.replace(/_/g,'-')
        console.log(containerPaymentMethod)

        window.klarnaAsyncCallback = function () {
            Klarna.Payments.init({
                client_token: '{{ client_token }}'
            });
            console.log("Payments initialized");
            //The following method loads the payment_method_category in the container with the id of 'klarna_container'
            Klarna.Payments.load({
                container: "#klarna-"+this.containerPaymentMethod+"-container",
                payment_method_category: '{{ payment_method }}'
            }, function (res) {
                console.log("Load function called");
                console.log(res);
                if(res.show_form === true)
                {
                    console.log('valid request - continue');
                }
                if(res.show_form === false){
                    console.log('invalid request - display error');
                }
            });
        };

        $(function(){
            $("button.authorize").on('click', function(){
                Klarna.Payments.authorize({
                    payment_method_category: '{{ payment_method }}'
                },{

                }, function(res) {
                    console.log("Response from the authorize call:");
                    console.log(res);
                    if(res.authorization_token)
                    {

                    }
                    if( (res.show_form === false ) && (res.approved === false )){
                        console.log('Disable Klarna’s widget and pre-select another payment method');
                    }else if ( (res.show_form === true ) && (res.approved === false ) ) {
                        console.log('Disable Klarna’s widget and pre-select another payment method');
                        console.log(res.error)
                    }else if ((res.show_form === true ) && (res.approved === true )) {
                        console.log('Authorization token received. Create order and redirect customer with authorization_token: ' + res.authorization_token );
                        $.ajax({
                            type: 'POST',
                            url: '/payment/payone/checkout/doKlarnaAuth',
                            authToken: res.authorization_token,
                            dataType: 'json',
                            async: true
                        }).done(function (data) {
                            if (data.data.redirecturl) {
                                window.location.replace(data.data.redirecturl);
                            }
                            console.log('done');
                            console.log(data);
                        }).fail(function (data) {
                            var data = data.responseJSON;
                            if (data.errors && data.errors.message) {
                                $.payonePayment.showErrorMessage(data.errors.message);
                            }
                            console.log(data);
                            console.log(data);
                        });
                    }else{
                        console.log( 'unexpected error');
                    }
                    if(res.show_form === false){
                        console.log('invalid request - display error');
                    }
                })
            })
        })

    </script>
    <script src="https://x.klarnacdn.net/kp/lib/v1/api.js" async></script>


    <div style="width: 500px; margin: auto; padding-top: 150px; padding-bottom: 30px;">
        <img src="https://x.klarnacdn.net/payment-method/assets/badges/generic/klarna.svg"
             style="width: 500px; margin: auto;">
    </div>

    <!--Klarna container-->
    <div id="klarna-pay-later-container" style="width: 500px; margin: auto;"></div>
    <div id="klarna-pay-now-container" style="width: 500px; margin: auto;"></div>
    <div id="klarna-pay-over-time-container" style="width: 500px; margin: auto;"></div>
    <div style="width: 500px; margin: auto;">
        <!--Button to trigger authorize call-->
        <button class="authorize" style="width: 500px; height: 50px; margin: auto;">Kaufen</button>
    </div>

{% endblock %}
